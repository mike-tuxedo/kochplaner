<div class="page-header">
    <h2>Einstellungen</h2>
</div>

<article class="settings-section">
    <h4>Darstellung</h4>
    <label>
        <input type="checkbox" role="switch" @change="toggleTheme()"/>
        {{ theme === 'light' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode' }}
    </label>
    <label>
        <input type="checkbox" role="switch" :checked="bubblesEnabled" @change="toggleBubbles()"/>
        ü´ß Hintergrund-Animation
    </label>
</article>

<article class="settings-section">
    <hgroup>
        <h4>Synchronisierung</h4>
        <p>Verschl√ºsselte Synchronisierung zwischen Ger√§ten.</p>
    </hgroup>

    <!-- State: Not configured -->
    <div v-if="syncState === 'none'" class="sync-setup">
        <button @click="startNewSync()" :disabled="syncLoading">
            <span v-if="syncLoading">Verbinde...</span>
            <span v-else>Neuen Sync starten</span>
        </button>
        <button class="secondary outline" @click="showImportKey()" :disabled="syncLoading">Mit bestehendem Ger√§t verbinden</button>
        <details class="mt-1">
            <summary>Erweiterte Einstellungen</summary>
            <label for="sync-server">Server-Adresse</label>
            <input type="text" id="sync-server" v-model="syncServerUrl" placeholder="wss://...">
        </details>
    </div>

    <!-- State: Import key -->
    <div v-if="syncState === 'importing'" class="sync-import">
        <p>Scanne den QR-Code vom anderen Ger√§t oder gib den Schl√ºssel manuell ein.</p>
        <div class="settings-actions">
            <button @click="startQRScanner()" :disabled="syncLoading">QR-Code scannen</button>
        </div>
        <details class="mt-1" open>
            <summary>Schl√ºssel manuell eingeben</summary>
            <input type="text" v-model="syncKeyInput" placeholder="Schl√ºssel einf√ºgen..." autocomplete="off">
            <div class="settings-actions">
                <button class="secondary" @click="importSyncKey()" :disabled="syncLoading || !syncKeyInput.trim()">
                    <span v-if="syncLoading">Verbinde...</span>
                    <span v-else>Verbinden</span>
                </button>
            </div>
        </details>
        <details class="mt-1">
            <summary>Erweiterte Einstellungen</summary>
            <label for="sync-server-import">Server-Adresse</label>
            <input type="text" id="sync-server-import" v-model="syncServerUrl" placeholder="wss://...">
        </details>
        <button class="secondary outline mt-1" @click="syncState = 'none'">Zur√ºck</button>
    </div>

    <!-- State: QR Scanner -->
    <div v-if="syncState === 'scanning'" class="sync-scanner">
        <div class="scanner-container">
            <video id="qr-video" muted playsinline></video>
            <div class="scanner-overlay"></div>
        </div>
        <button class="secondary outline" @click="cancelQRScanner()">Abbrechen</button>
    </div>

    <!-- State: Active -->
    <div v-if="syncState === 'active'" class="sync-active">
        <p class="sync-status">
            <span v-if="syncConnected" class="status-connected">‚óè Verbunden</span>
            <span v-else class="status-disconnected">‚óã Nicht verbunden</span>
        </p>
        <p v-if="syncDecryptError" class="sync-error">Entschl√ºsselung fehlgeschlagen ‚Äî falscher Schl√ºssel?</p>
        <div class="settings-actions">
            <button @click="showShareKey()">Weiteres Ger√§t verbinden</button>
            <button class="secondary outline" @click="disableSync()">Sync deaktivieren</button>
        </div>
    </div>

    <!-- State: Share key -->
    <div v-if="syncState === 'sharing'" class="sync-share">
        <p>Scanne diesen QR-Code auf dem anderen Ger√§t unter <em>‚ÄûMit bestehendem Ger√§t verbinden"</em>.</p>
        <div class="qr-display">
            <canvas id="qr-canvas"></canvas>
        </div>
        <div class="sync-key-display">
            <code class="sync-key-text">{{ syncKey }}</code>
            <button type="button" class="sync-key-copy" @click="shareSyncKey()" title="Kopieren / Teilen">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V21C16.9998 21.5523 16.5521 22 15.9998 22H3.9998C3.44752 22 2.9998 21.5523 2.9998 21V7C2.9998 6.44772 3.44752 6 3.9998 6H6.9998ZM8.9998 6H15.9998C16.5521 6 16.9998 6.44772 16.9998 7V16H18.9998V4H8.9998V6ZM4.9998 8V20H14.9998V8H4.9998Z"></path>
                </svg>
            </button>
        </div>
        <div class="settings-actions">
            <button class="secondary outline" @click="backToSyncActive()">Zur√ºck</button>
        </div>
    </div>
</article>

<article class="settings-section">
    <hgroup>
        <h4>Spracheingabe</h4>
        <p>Offline-Spracherkennung f√ºr Rezepte und Einkaufsliste.</p>
    </hgroup>
    <div v-if="!speechEnabled">
        <p class="speech-info">Beim Aktivieren wird einmalig ein deutsches Sprachmodell (~45 MB) heruntergeladen. Danach funktioniert die Erkennung vollst√§ndig offline.</p>
        <button @click="enableSpeech()" :disabled="speechLoading">
            <span v-if="speechLoading && speechProgress > 0 && speechProgress < 100">Lade Modell... {{ speechProgress }}%</span>
            <span v-else-if="speechLoading && speechProgress >= 100">Initialisiere...</span>
            <span v-else-if="speechLoading">Verbinde...</span>
            <span v-else>Spracheingabe aktivieren</span>
        </button>
        <progress v-if="speechLoading && speechProgress > 0 && speechProgress < 100" :value="speechProgress" max="100"></progress>
    </div>
    <div v-else>
        <p class="status-connected">Spracheingabe aktiv</p>
        <button class="secondary outline" @click="disableSpeech()">Deaktivieren</button>
    </div>
</article>

<article class="settings-section">
    <hgroup>
        <h4>Rezepte verwalten</h4>
        <p>Backups erstellen und wiederherstellen. Beim Import werden nur neue Rezepte hinzugef√ºgt.</p>
    </hgroup>
    <div class="settings-actions">
        <button class="secondary" @click="exportRecipes()">Exportieren</button>
        <label class="secondary" role="button">
            Importieren
            <input type="file" accept=".json" @change="importRecipes($event)" hidden>
        </label>
    </div>
</article>

<article class="settings-section">
    <hgroup>
        <h4>Vordefinierte Rezepte</h4>
        <p>Eine Vorauswahl an Rezepten importieren. Bestehende Rezepte bleiben erhalten.</p>
    </hgroup>
    <button class="secondary" @click="loadDefaultRecipes()">Standardrezepte laden</button>
</article>

<article class="settings-section" v-if="canInstall">
    <hgroup>
        <h4>App installieren</h4>
        <p>Installiere die App f√ºr schnelleren Zugriff und Offline-Nutzung.</p>
    </hgroup>
    <button @click="window.installApp()">App installieren</button>
</article>

<article class="settings-section danger-zone">
    <hgroup>
        <h4>Daten zur√ºcksetzen</h4>
        <p>Alle Rezepte und Wochenpl√§ne werden unwiderruflich gel√∂scht.</p>
    </hgroup>
    <button class="secondary" @click="resetAllData()">Alle Daten l√∂schen</button>
</article>

<article class="settings-section">
    <h4>√úber die App</h4>
    <p>Kochplaner - Dein pers√∂nlicher Wochenplaner</p>
    <small>Version 1.5 | Offline-f√§hig | E2E-verschl√ºsselt</small>
</article>

<article class="settings-section coffee-section">
    <p>Wenn du willst, kannst du mir gerne einen Kaffee spendieren ;-)</p>
    <a href="https://www.buymeacoffee.com/miketuxedoo" target="_blank" id="buymeacoffee"><img src="images/qr-code.png" alt="Buy Me A Coffee"></a>
</article>