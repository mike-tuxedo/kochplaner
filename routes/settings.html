<div class="page-header">
    <h2>Einstellungen</h2>
</div>

<article class="settings-section">
    <h4>Darstellung</h4>
    <label>
        <input type="checkbox" role="switch" @change="toggleTheme()"/>
        {{ theme === 'light' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode' }}
    </label>
    <label>
        <input type="checkbox" role="switch" :checked="bubblesEnabled" @change="toggleBubbles()"/>
        ü´ß Hintergrund-Animation
    </label>
</article>

<article class="settings-section">
    <hgroup>
        <h4>Synchronisierung</h4>
        <p>Verschl√ºsselte Synchronisierung zwischen Ger√§ten.</p>
    </hgroup>

    <!-- State: Not configured -->
    <div v-if="syncState === 'none'" class="sync-setup">
        <button @click="startNewSync()" :disabled="syncLoading">
            <span v-if="syncLoading">Verbinde...</span>
            <span v-else><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C15.866 2 19 5.13401 19 9C19 9.11351 18.9973 9.22639 18.992 9.33857C21.3265 10.16 23 12.3846 23 15C23 18.3137 20.3137 21 17 21H7C3.68629 21 1 18.3137 1 15C1 12.3846 2.67346 10.16 5.00804 9.33857C5.0027 9.22639 5 9.11351 5 9C5 5.13401 8.13401 2 12 2ZM12 4C9.23858 4 7 6.23858 7 9C7 9.08147 7.00193 9.16263 7.00578 9.24344L7.07662 10.7309L5.67183 11.2252C4.0844 11.7837 3 13.2889 3 15C3 17.2091 4.79086 19 7 19H17C19.2091 19 21 17.2091 21 15C21 12.79 19.21 11 17 11C15.233 11 13.7337 12.1457 13.2042 13.7347L11.3064 13.1021C12.1005 10.7185 14.35 9 17 9C17 6.23858 14.7614 4 12 4Z"></path></svg> Neuen Sync starten</span>
        </button>
        <button class="secondary outline" @click="showImportKey()" :disabled="syncLoading">Mit bestehendem Ger√§t verbinden</button>
        <details class="mt-1">
            <summary>Weitere Infos zur Synchronisierung</summary>
            <p>Du kannst mehrere Ger√§te von dir und anderen Person miteinander synchronisieren. Dazu musst du nur initial auf einem Ger√§t einmal "Neuen Sync starten" w√§hlen und bei allen weiteren Ger√§ten "Mit bestehendem Ger√§t verbinden".</p>
            <p>Deine Daten werden sicher und verschl√ºsselt zwischen den Ger√§ten ausgetauscht.</p>
            <mark>Wichtig ist zu beachten, das alle Daten synchronisiert werden. L√∂scht du zB ein Rezept, wird es bei allen gel√∂scht.</mark>
        </details>
        
        <details class="mt-1">
            <summary>Erweiterte Einstellungen</summary>
            <p>Hier nur etwas √§ndern, wenn du einen eigenen Synchronisierungsserver hostest.</p>
            <label for="sync-server">Server-Adresse</label>
            <input type="text" id="sync-server" v-model="syncServerUrl" placeholder="wss://...">
        </details>
    </div>

    <!-- State: Import key -->
    <div v-if="syncState === 'importing'" class="sync-import">
        <p>Scanne den QR-Code vom anderen Ger√§t oder gib den Schl√ºssel manuell ein.</p>
        <div class="settings-actions">
            <button @click="startQRScanner()" :disabled="syncLoading">QR-Code scannen</button>
        </div>
        <details class="mt-1" open>
            <summary>Schl√ºssel manuell eingeben</summary>
            <input type="text" v-model="syncKeyInput" placeholder="Schl√ºssel einf√ºgen..." autocomplete="off">
            <div class="settings-actions">
                <button class="secondary" @click="importSyncKey()" :disabled="syncLoading || !syncKeyInput.trim()">
                    <span v-if="syncLoading">Verbinde...</span>
                    <span v-else>Verbinden</span>
                </button>
            </div>
        </details>
        <details class="mt-1">
            <summary>Erweiterte Einstellungen</summary>
            <label for="sync-server-import">Server-Adresse</label>
            <input type="text" id="sync-server-import" v-model="syncServerUrl" placeholder="wss://...">
        </details>
        <button class="secondary outline mt-1" @click="syncState = 'none'">Zur√ºck</button>
    </div>

    <!-- State: QR Scanner -->
    <div v-if="syncState === 'scanning'" class="sync-scanner">
        <div class="scanner-container">
            <video id="qr-video" muted playsinline></video>
            <div class="scanner-overlay"></div>
        </div>
        <button class="secondary outline" @click="cancelQRScanner()">Abbrechen</button>
    </div>

    <!-- State: Active -->
    <div v-if="syncState === 'active'" class="sync-active">
        <p class="sync-status">
            <span v-if="syncConnected" class="status-connected">‚óè Verbunden</span>
            <span v-else class="status-disconnected">‚óã Nicht verbunden</span>
        </p>
        <p v-if="syncDecryptError" class="sync-error">Entschl√ºsselung fehlgeschlagen ‚Äî falscher Schl√ºssel?</p>
        <div class="settings-actions">
            <button @click="showShareKey()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H21C21.5523 8 22 8.44772 22 9V21C22 21.5523 21.5523 22 21 22H13C12.4477 22 12 21.5523 12 21V20H4C3.44772 20 3 19.5523 3 19V3C3 2.44772 3.44772 2 4 2H18C18.5523 2 19 2.44772 19 3V8ZM17 8V4H5V18H12V9C12 8.44772 12.4477 8 13 8H17ZM14 10V20H20V10H14Z"></path></svg>
                Weiteres Ger√§t verbinden
            </button>
            <button class="secondary outline" @click="disableSync()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3.51472 2.10051L22.6066 21.1924L21.1924 22.6066L19.1782 20.5924C18.503 20.8556 17.7684 21 17 21H7C3.68629 21 1 18.3137 1 15C1 12.3846 2.67346 10.16 5.00804 9.33857C5.0027 9.22639 5 9.11351 5 9C5 8.22228 5.12683 7.47418 5.36094 6.77527L2.10051 3.51472L3.51472 2.10051ZM7 9C7 9.08147 7.00193 9.16263 7.00578 9.24344L7.07662 10.7309L5.67183 11.2252C4.0844 11.7837 3 13.2889 3 15C3 17.2091 4.79086 19 7 19H17C17.1858 19 17.3687 18.9873 17.5478 18.9628L7.03043 8.44519C7.01032 8.62736 7 8.81247 7 9ZM12 2C15.866 2 19 5.13401 19 9C19 9.11351 18.9973 9.22639 18.992 9.33857C21.3265 10.16 23 12.3846 23 15C23 16.0883 22.7103 17.1089 22.2037 17.9889L20.7111 16.4955C20.8974 16.0335 21 15.5287 21 15C21 12.79 19.21 11 17 11C16.4711 11 15.9661 11.1027 15.5039 11.2892L14.0111 9.7964C14.8912 9.28978 15.9118 9 17 9C17 6.23858 14.7614 4 12 4C10.9295 4 9.93766 4.33639 9.12428 4.90922L7.69418 3.48056C8.88169 2.55284 10.3763 2 12 2Z"></path></svg> Sync deaktivieren</button>
        </div>
    </div>

    <!-- State: Share key -->
    <div v-if="syncState === 'sharing'" class="sync-share">
        <p>Scanne diesen QR-Code auf dem anderen Ger√§t unter <em>‚ÄûMit bestehendem Ger√§t verbinden"</em>.</p>
        <div class="qr-display">
            <canvas id="qr-canvas"></canvas>
        </div>
        <div class="sync-key-display">
            <code class="sync-key-text">{{ syncKey }}</code>
            <button type="button" class="sync-key-copy" @click="shareSyncKey()" title="Kopieren / Teilen">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V21C16.9998 21.5523 16.5521 22 15.9998 22H3.9998C3.44752 22 2.9998 21.5523 2.9998 21V7C2.9998 6.44772 3.44752 6 3.9998 6H6.9998ZM8.9998 6H15.9998C16.5521 6 16.9998 6.44772 16.9998 7V16H18.9998V4H8.9998V6ZM4.9998 8V20H14.9998V8H4.9998Z"></path>
                </svg>
            </button>
        </div>
        <div class="settings-actions">
            <button class="secondary outline" @click="backToSyncActive()">Zur√ºck</button>
        </div>
    </div>
</article>

<article class="settings-section">
    <hgroup>
        <h4>Spracheingabe</h4>
        <p>Offline-Spracherkennung f√ºr Rezepte und Einkaufsliste.</p>
    </hgroup>
    <div v-if="!speechEnabled">
        <p class="speech-info">Beim Aktivieren wird einmalig ein deutsches Sprachmodell (~45 MB) heruntergeladen. Danach funktioniert die Erkennung vollst√§ndig offline.</p>
        <button @click="enableSpeech()" :disabled="speechLoading">
            <span v-if="speechLoading && speechProgress > 0 && speechProgress < 100">Lade Modell... {{ speechProgress }}%</span>
            <span v-else-if="speechLoading && speechProgress >= 100">Initialisiere...</span>
            <span v-else-if="speechLoading">Verbinde...</span>
            <span v-else><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.0001 3C10.3432 3 9.00008 4.34315 9.00008 6V12C9.00008 13.6569 10.3432 15 12.0001 15C13.6569 15 15.0001 13.6569 15.0001 12V6C15.0001 4.34315 13.6569 3 12.0001 3ZM12.0001 1C14.7615 1 17.0001 3.23858 17.0001 6V12C17.0001 14.7614 14.7615 17 12.0001 17C9.23865 17 7.00008 14.7614 7.00008 12V6C7.00008 3.23858 9.23865 1 12.0001 1ZM2.19238 13.9615L4.15392 13.5692C4.88321 17.2361 8.11888 20 12.0001 20C15.8813 20 19.1169 17.2361 19.8462 13.5692L21.8078 13.9615C20.8961 18.5452 16.8516 22 12.0001 22C7.14858 22 3.104 18.5452 2.19238 13.9615Z"></path></svg> Spracheingabe aktivieren</span>
        </button>
        <progress v-if="speechLoading && speechProgress > 0 && speechProgress < 100" :value="speechProgress" max="100"></progress>
    </div>
    <div v-else>
        <p class="status-connected">Spracheingabe aktiv</p>
        <button class="secondary outline" @click="disableSpeech()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.4249 17.839L21.1925 22.6066L22.6068 21.1924L2.80777 1.3934L1.39355 2.80761L7.00016 8.41421V10C7.00016 12.7614 9.23873 15 12.0002 15C12.4825 15 12.9489 14.9317 13.3902 14.8042L14.9404 16.3544C14.0464 16.7688 13.0503 17 12.0002 17C8.47368 17 5.55627 14.3923 5.07105 11H3.05509C3.51623 15.1716 6.82854 18.4839 11.0002 18.9451V23H13.0002V18.9451C14.2341 18.8087 15.3929 18.4228 16.4249 17.839ZM11.5528 12.9669C10.2541 12.7727 9.22745 11.7461 9.03328 10.4473L11.5528 12.9669ZM19.3747 15.1604L17.9323 13.7179C18.4407 12.9084 18.788 11.9874 18.9293 11H20.9452C20.7754 12.5366 20.2187 13.9565 19.3747 15.1604ZM16.4658 12.2514L14.9173 10.703C14.9715 10.4775 15.0002 10.2421 15.0002 10V6C15.0002 4.34315 13.657 3 12.0002 3C10.7059 3 9.6031 3.81956 9.18237 4.96802L7.68575 3.47139C8.55427 1.99268 10.1613 1 12.0002 1C14.7616 1 17.0002 3.23858 17.0002 6V10C17.0002 10.8099 16.8076 11.5748 16.4658 12.2514Z"></path></svg> Deaktivieren</button>
    </div>
</article>

<article class="settings-section">
    <hgroup>
        <h4>Rezepte verwalten</h4>
        <p>Backups erstellen und wiederherstellen. Beim Import werden nur neue Rezepte hinzugef√ºgt.</p>
    </hgroup>
    <div class="settings-actions">
        <button class="secondary" @click="exportRecipes()">Exportieren</button>
        <label class="secondary" role="button">
            Importieren
            <input type="file" accept=".json" @change="importRecipes($event)" hidden>
        </label>
    </div>
</article>

<article class="settings-section">
    <hgroup>
        <h4>Vordefinierte Rezepte</h4>
        <p>Eine Vorauswahl an Rezepten importieren. Bestehende Rezepte bleiben erhalten.</p>
    </hgroup>
    <button class="secondary" @click="loadDefaultRecipes()">Standardrezepte laden</button>
</article>

<article class="settings-section" v-if="canInstall">
    <hgroup>
        <h4>App installieren</h4>
        <p>Installiere die App f√ºr schnelleren Zugriff und Offline-Nutzung.</p>
    </hgroup>
    <button @click="window.installApp()">App installieren</button>
</article>

<article class="settings-section danger-zone">
    <hgroup>
        <h4>Daten zur√ºcksetzen</h4>
        <p>Alle Rezepte und Wochenpl√§ne werden unwiderruflich gel√∂scht.</p>
    </hgroup>
    <button class="secondary" @click="resetAllData()">Alle Daten l√∂schen</button>
</article>

<article class="settings-section">
    <h4>√úber die App</h4>
    <p>Kochplaner - Dein pers√∂nlicher Wochenplaner</p>
    <small>Version 1.5 | Offline-f√§hig | E2E-verschl√ºsselt</small>
    <p class="storage-status mt-1">
        <small v-if="storagePersisted" class="status-connected">Persistenter Speicher aktiv ‚Äî Daten werden vom Browser nicht automatisch gel√∂scht.</small>
        <small v-else class="status-disconnected">Kein persistenter Speicher ‚Äî der Browser k√∂nnte bei Speicherknappheit Daten l√∂schen. Installiere die App oder aktiviere Sync als Backup.</small>
    </p>
</article>

<article class="settings-section coffee-section">
    <p>Wenn du willst, kannst du mir gerne einen Kaffee spendieren ;-)</p>
    <a href="https://www.buymeacoffee.com/miketuxedoo" target="_blank" id="buymeacoffee"><img src="images/qr-code.png" alt="Buy Me A Coffee"></a>
</article>